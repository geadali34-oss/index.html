<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الجمعيات التعاونية | تنظيم الدفعات بدون فوائد</title>
    <!-- تبقى كافة أنماط التصميم (CSS) السابقة كما هي هنا -->
    <style>
        :root { --rajhi-red: #CE1126; --ahli-blue: #0056A3; --primary: #1A5F7A; --success: #2E8B57; --warning: #FFB800; --danger: #DC3545; --dark: #2D3047; --light: #F8F9FA; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(rgba(255,255,255,0.95), rgba(255,255,255,0.95)), url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIiBwYXR0ZXJuVHJhbnNmb3JtPSJyb3RhdGUoNDUpIj48cGF0aCBkPSJNIDAgMCBMIDQwIDQwIE0gMCAtNDAgTCA0MCAwIE0gLTQwIDAgTCAwIDQwIiBzdHJva2U9IiMxQTVGN0EiIHN0cm9rZS13aWR0aD0iMC41IiBmaWxsPSJub25lIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3BhdHRlcm4pIi8+PC9zdmc+'); min-height: 100vh; }
        .main-header { background: linear-gradient(135deg, var(--rajhi-red), #E74C3C); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(206, 17, 38, 0.2); }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo { font-size: 2.5em; background: white; width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: var(--rajhi-red); }
        .logo-text h1 { font-size: 1.8em; margin-bottom: 5px; }
        .logo-text p { opacity: 0.9; font-size: 0.9em; }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .main-nav { background: white; padding: 0 30px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 1000; }
        .nav-list { display: flex; list-style: none; justify-content: center; }
        .nav-item { padding: 20px 25px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; font-weight: 600; color: #555; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { color: var(--primary); background: rgba(26, 95, 122, 0.05); }
        .nav-item.active { color: var(--rajhi-red); border-bottom-color: var(--rajhi-red); }
        .main-content { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .page-section { display: none; animation: fadeIn 0.5s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .section-card { background: white; border-radius: 20px; padding: 40px; margin-bottom: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid #e1e5eb; }
        .section-title { color: var(--primary); font-size: 2em; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid var(--rajhi-red); display: flex; align-items: center; gap: 15px; }
        .intro-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 30px; }
        .intro-card { background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; padding: 30px; border-right: 5px solid var(--primary); }
        .intro-card h3 { color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .warning-box { background: #FFF3CD; border: 2px solid #FFEEBA; border-radius: 15px; padding: 25px; margin: 30px 0; color: #856404; }
        .warning-box h4 { color: #856404; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .registration-steps { display: flex; justify-content: space-between; margin-bottom: 40px; position: relative; }
        .step-indicator { text-align: center; position: relative; z-index: 1; }
        .step-number { width: 50px; height: 50px; background: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; margin: 0 auto 10px; transition: all 0.3s; }
        .step-indicator.active .step-number { background: var(--primary); color: white; transform: scale(1.1); }
        .step-line { position: absolute; top: 25px; right: 10%; left: 10%; height: 3px; background: #e9ecef; z-index: 0; }
        .reg-form { max-width: 800px; margin: 0 auto; }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 8px; color: #495057; font-weight: 500; }
        .form-input { width: 100%; padding: 15px 20px; border: 2px solid #dee2e6; border-radius: 12px; font-size: 16px; transition: all 0.3s; }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.1); outline: none; }
        .form-actions { display: flex; justify-content: space-between; margin-top: 40px; padding-top: 30px; border-top: 2px solid #f1f3f4; }
        .btn { padding: 15px 30px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #2C3E50); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(26, 95, 122, 0.3); }
        .btn-secondary { background: #f8f9fa; color: #495057; }
        .plans-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin: 40px 0; }
        .plan-card { border: 2px solid #dee2e6; border-radius: 15px; padding: 25px; transition: all 0.3s; position: relative; cursor: pointer; }
        .plan-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .plan-card.selected { border-color: var(--primary); background: rgba(26, 95, 122, 0.05); }
        .plan-badge { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--rajhi-red); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .plan-price { font-size: 2em; font-weight: 800; color: var(--primary); margin: 15px 0; }
        .plan-features { list-style: none; margin: 15px 0; }
        .plan-features li { padding: 8px 0; border-bottom: 1px solid #f1f3f4; display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
        .receipt-upload { border: 2px dashed #dee2e6; border-radius: 15px; padding: 40px; text-align: center; margin: 20px 0; cursor: pointer; transition: all 0.3s; }
        .receipt-upload:hover { border-color: var(--primary); background: rgba(26, 95, 122, 0.05); }
        .receipt-upload i { font-size: 3em; color: var(--primary); margin-bottom: 15px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); border-top: 4px solid var(--primary); }
        .stat-value { font-size: 2em; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .stat-label { color: #6c757d; font-size: 0.9em; }
        .chat-container { display: grid; grid-template-columns: 300px 1fr; gap: 25px; height: 600px; }
        .chat-sidebar { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .chat-messages { background: white; border-radius: 15px; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .messages-header { padding: 20px; border-bottom: 2px solid #f1f3f4; background: var(--primary); color: white; border-radius: 15px 15px 0 0; }
        .messages-list { flex: 1; overflow-y: auto; padding: 20px; }
        .message-input { padding: 20px; border-top: 2px solid #f1f3f4; }
        .main-footer { background: var(--dark); color: white; padding: 50px 30px 20px; margin-top: 50px; }
        .footer-content { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; }
        .footer-section h3 { color: white; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--rajhi-red); }
        .footer-links { list-style: none; }
        .footer-links li { margin-bottom: 10px; }
        .footer-links a { color: #adb5bd; text-decoration: none; transition: color 0.3s; }
        .footer-links a:hover { color: white; }
        .copyright { text-align: center; padding-top: 30px; margin-top: 30px; border-top: 1px solid #495057; color: #adb5bd; font-size: 0.9em; }
        /* أضف الأنماط الجديدة هنا */
        .bank-selection-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .bank-option-card { padding: 20px; border: 2px solid #dee2e6; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: 100%; min-height: 220px; }
        .bank-option-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .bank-option-card.selected { border-color: var(--primary); background: rgba(26, 95, 122, 0.02); }
        .bank-logo-container { display: flex; align-items: center; justify-content: center; height: 80px; margin-bottom: 15px; }
        .bank-logo { max-width: 120px; max-height: 50px; width: auto; height: auto; object-fit: contain; }
        .bank-transfer-btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 8px; padding: 12px 15px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-top: 15px; transition: all 0.3s; text-decoration: none; }
        .bank-transfer-btn:hover { background: linear-gradient(135deg, #45a049, #3d8b40); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3); text-decoration: none; }
        .bank-transfer-btn.rajhi { background: linear-gradient(135deg, #CE1126, #b30f22); }
        .bank-transfer-btn.rajhi:hover { background: linear-gradient(135deg, #b30f22, #9a0d1d); box-shadow: 0 5px 15px rgba(206, 17, 38, 0.3); }
        .bank-transfer-btn.ahli { background: linear-gradient(135deg, #0056A3, #004a8c); }
        .bank-transfer-btn.ahli:hover { background: linear-gradient(135deg, #004a8c, #003e76); box-shadow: 0 5px 15px rgba(0, 86, 163, 0.3); }
        .account-number-display { background: #f8f9fa; padding: 20px; border-radius: 12px; border: 2px dashed #dee2e6; margin: 25px 0; text-align: center; }
        .account-number { font-size: 1.2em; font-weight: 800; color: var(--primary); letter-spacing: 1px; direction: ltr; text-align: center; display: block; margin-top: 10px; font-family: monospace; }
        @media (max-width: 768px) {
            .main-nav { padding: 0 15px; }
            .nav-list { flex-direction: column; }
            .nav-item { padding: 15px; text-align: center; justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            .plans-container { grid-template-columns: 1fr; }
            .chat-container { grid-template-columns: 1fr; height: auto; }
            .registration-steps { flex-direction: column; gap: 20px; }
            .step-line { display: none; }
            /* استجابة للبنوك على الهاتف */
            .bank-selection-container { grid-template-columns: 1fr; gap: 15px; }
        }
    </style>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- رأس الصفحة -->
    <header class="main-header">
        <div class="logo-container">
            <div class="logo">
                <i class="fas fa-hands-helping"></i>
            </div>
            <div class="logo-text">
                <h1>منصة الجمعيات التعاونية</h1>
                <p>تنظيم الدفعات بدون فوائد • نظام توفير جماعي آمن</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openLogin()">
                <i class="fas fa-sign-in-alt"></i> دخول الأعضاء
            </button>
        </div>
    </header>
    
    <!-- شريط التنقل -->
    <nav class="main-nav">
        <ul class="nav-list">
            <li class="nav-item active" onclick="showPage('home')">
                <i class="fas fa-home"></i> الرئيسية
            </li>
            <li class="nav-item" onclick="showPage('register')">
                <i class="fas fa-user-plus"></i> التسجيل
            </li>
            <li class="nav-item" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt"></i> لوحة التحكم
            </li>
            <li class="nav-item" onclick="showPage('chat')">
                <i class="fas fa-comments"></i> الدردشة
            </li>
            <li class="nav-item" onclick="showPage('about')">
                <i class="fas fa-info-circle"></i> عن الجمعية
            </li>
        </ul>
    </nav>
    
    <!-- المحتوى الرئيسي -->
    <main class="main-content">
        <!-- الصفحة الرئيسية -->
        <section id="home" class="page-section active">
            <div class="section-card">
                <h2 class="section-title">
                    <i class="fas fa-hands-helping"></i> مرحباً بك في منصة الجمعيات التعاونية
                </h2>
                
                <div class="warning-box">
                    <h4><i class="fas fa-exclamation-triangle"></i> ملاحظة هامة:</h4>
                    <p>الجمعية ليست استثماراً ولا تقدم أرباحاً. هذا نظام توفير جماعي لتنظيم الدفعات بدون فوائد أو أرباح. كل عضو يحصل على مبلغ الجمعية مرة واحدة حسب دور الاستلام المحدد له.</p>
                </div>
                
                <div class="intro-grid">
                    <div class="intro-card">
                        <h3><i class="fas fa-handshake"></i> مفهوم الجمعية</h3>
                        <p>نظام توفير جماعي حيث يجتمع عدد من الأفراد على دفعة شهرية ثابتة، ويحصل كل عضو على مجموع الدفعات مرة واحدة حسب الدور المحدد له.</p>
                    </div>
                    
                    <div class="intro-card">
                        <h3><i class="fas fa-shield-alt"></i> الأمان والشفافية</h3>
                        <p>جميع العمليات مسجلة وشفافة. ربط مباشر مع الحسابات البنكية للقراءة فقط. لا يوجد وصول لأموال الأعضاء.</p>
                    </div>
                    
                    <div class="intro-card">
                        <h3><i class="fas fa-calendar-check"></i> نظام الأدوار</h3>
                        <p>كل عضو يحصل على دور ثابت للاستلام. النظام يضمن العدالة والتنظيم الدقيق للأدوار بناءً على تسلسل الانضمام.</p>
                    </div>
                    
                    <div class="intro-card">
                        <h3><i class="fas fa-users"></i> مجتمع متعاون</h3>
                        <p>نعمل على بناء مجتمع تعاوني يساعد بعضه البعض في تحقيق أهداف التوفير بطريقة منظمة وآمنة.</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn btn-primary" onclick="showPage('register')" style="padding: 20px 50px; font-size: 1.2em;">
                        <i class="fas fa-user-plus"></i> ابدأ التسجيل الآن
                    </button>
                </div>
            </div>
        </section>
        
        <!-- صفحة التسجيل -->
        <section id="register" class="page-section">
            <div class="section-card">
                <h2 class="section-title"><i class="fas fa-user-plus"></i> تسجيل عضو جديد</h2>
                
                <!-- خطوات التسجيل -->
                <div class="registration-steps">
                    <div class="step-line"></div>
                    <div class="step-indicator active" id="step1-indicator">
                        <div class="step-number">1</div>
                        <div>البيانات الشخصية</div>
                    </div>
                    <div class="step-indicator" id="step2-indicator">
                        <div class="step-number">2</div>
                        <div>اختيار الجمعية</div>
                    </div>
                    <div class="step-indicator" id="step3-indicator">
                        <div class="step-number">3</div>
                        <div>التأكيد والدفع</div>
                    </div>
                </div>
                
                <!-- نموذج التسجيل -->
                <form id="registrationForm" class="reg-form">
                    <!-- الخطوة 1: البيانات الشخصية -->
                    <div class="form-step active" id="step1-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label><i class="fas fa-user"></i> الاسم بالكامل *</label>
                                <input type="text" class="form-input" id="fullName" required placeholder="أدخل اسمك الكامل">
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-id-card"></i> رقم الهوية الوطنية *</label>
                                <input type="text" class="form-input" id="nationalId" required pattern="[0-9]{10}" placeholder="10 أرقام">
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-phone"></i> رقم الجوال *</label>
                                <input type="tel" class="form-input" id="phone" required placeholder="05xxxxxxxx">
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-envelope"></i> البريد الإلكتروني *</label>
                                <input type="email" class="form-input" id="email" required placeholder="example@email.com">
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-city"></i> المدينة *</label>
                                <select class="form-input" id="city" required>
                                    <option value="">اختر المدينة</option>
                                    <option value="riyadh">الرياض</option>
                                    <option value="jeddah">جدة</option>
                                    <option value="mecca">مكة المكرمة</option>
                                    <option value="medina">المدينة المنورة</option>
                                    <option value="dammam">الدمام</option>
                                    <option value="khobar">الخبر</option>
                                    <option value="dhahran">الظهران</option>
                                    <option value="ahsa">الأحساء</option>
                                    <option value="qatif">القطيف</option>
                                    <option value="taif">الطائف</option>
                                    <option value="buraidah">بريدة</option>
                                    <option value="hail">حائل</option>
                                    <option value="tabuk">تبوك</option>
                                    <option value="jazan">جازان</option>
                                    <option value="najran">نجران</option>
                                    <option value="abha">أبها</option>
                                    <option value="khamis">خميس مشيط</option>
                                    <option value="yanbu">ينبع</option>
                                    <option value="jubail">الجبيل</option>
                                    <option value="hafr">حفر الباطن</option>
                                    <option value="qassim">القصيم</option>
                                    <option value="asir">عسير</option>
                                    <option value="bahah">الباحة</option>
                                    <option value="jawf">الجوف</option>
                                    <option value="northern">الحدود الشمالية</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-birthday-cake"></i> تاريخ الميلاد *</label>
                                <input type="date" class="form-input" id="birthDate" required>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                                التالي <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- الخطوة 2: اختيار الجمعية -->
                    <div class="form-step" id="step2-form">
                        <h3 style="color: var(--primary); margin-bottom: 30px; text-align: center;">
                            <i class="fas fa-money-check-alt"></i> اختر نوع الجمعية المناسب لك
                        </h3>
                        
                        <div class="plans-container">
                            <!-- باقة 500 ريال -->
                            <div class="plan-card" data-plan="500" onclick="selectPlan('500')">
                                <div class="plan-badge">الأكثر شيوعاً</div>
                                <h3><i class="fas fa-coins"></i> جمعية 500 ريال</h3>
                                <div class="plan-price">500 ر.س</div>
                                <p>شهرياً لمدة 12 شهر</p>
                                <ul class="plan-features">
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> مبلغ مناسب للجميع</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> دور استلام محدد</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> متابعة شهرية</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> إشعارات تلقائية</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> دعم فني متكامل</li>
                                </ul>
                                <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="selectPlan('500')">
                                    <i class="fas fa-check"></i> اختر هذه الجمعية
                                </button>
                            </div>
                            
                            <!-- باقة 1000 ريال -->
                            <div class="plan-card" data-plan="1000" onclick="selectPlan('1000')">
                                <div class="plan-badge">الأفضل قيمة</div>
                                <h3><i class="fas fa-gem"></i> جمعية 1000 ريال</h3>
                                <div class="plan-price">1,000 ر.س</div>
                                <p>شهرياً لمدة 12 شهر</p>
                                <ul class="plan-features">
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> جميع مميزات 500 ريال</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> تأمين إضافي</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> متابعة شخصية</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> أولوية في الدور</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> تقارير شهرية</li>
                                </ul>
                                <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="selectPlan('1000')">
                                    <i class="fas fa-check"></i> اختر هذه الجمعية
                                </button>
                            </div>
                            
                            <!-- باقة 5000 ريال -->
                            <div class="plan-card" data-plan="5000" onclick="selectPlan('5000')">
                                <div class="plan-badge">VIP</div>
                                <h3><i class="fas fa-crown"></i> جمعية 5000 ريال</h3>
                                <div class="plan-price">5,000 ر.س</div>
                                <p>شهرياً لمدة 12 شهر</p>
                                <ul class="plan-features">
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> جميع المميزات السابقة</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> ضمانات إضافية</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> محفظة رقمية</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> دعم فوري 24/7</li>
                                    <li><i class="fas fa-check-circle" style="color: var(--success);"></i> مدير حساب شخصي</li>
                                </ul>
                                <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="selectPlan('5000')">
                                    <i class="fas fa-check"></i> اختر هذه الجمعية
                                </button>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px; color: #6c757d; font-size: 0.9em;">
                            <p id="selectedPlanText" style="display: none; color: var(--primary); font-weight: 600;">
                                <i class="fas fa-check-circle"></i> تم اختيار جمعية <span id="selectedPlanName"></span>
                            </p>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="prevStep()">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep(3)" id="nextStep3Btn">
                                التالي <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- الخطوة 3: التأكيد والدفع -->
                    <div class="form-step" id="step3-form">
                        <h3 style="color: var(--primary); margin-bottom: 30px; text-align: center;">
                            <i class="fas fa-clipboard-check"></i> تأكيد البيانات والدفع
                        </h3>
                        
                        <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                            <h4 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-user-check"></i> بيانات التسجيل:
                            </h4>
                            <div id="reviewData"></div>
                        </div>
                        
                        <!-- عرض رقم حساب الجمعية الجديد -->
                        <div class="account-number-display">
                            <h4 style="color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <i class="fas fa-university"></i> رقم حساب الجمعية (IBAN) للتحويل
                            </h4>
                            <p style="color: #6c757d; margin-bottom: 5px;">يرجى استخدام الرقم التالي للتحويل في أي من البنكين:</p>
                            <span class="account-number" id="associationAccountNumber">SA035600035686889898989898585</span>
                            <p style="color: #6c757d; font-size: 0.9em; margin-top: 15px;">
                                <i class="fas fa-info-circle"></i> تأكد من مطابقة رقم الحساب أعلاه قبل إجراء أي تحويل.
                            </p>
                        </div>
                        
                        <!-- اختيار البنك والتحويل -->
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-university"></i> اختر بنك التحويل *
                            </label>
                            <p style="color: #6c757d; margin-top: 5px; margin-bottom: 15px; font-size: 0.95em;">اختر البنك الذي تريد التحويل منه. يمكنك فتح تطبيق البنك مباشرةً لإكمال عملية التحويل.</p>
                            
                            <div class="bank-selection-container">
                                <!-- بنك الراجحي -->
                                <div class="bank-option-card" id="rajhi-option-card" onclick="selectBank('rajhi')">
                                    <div class="bank-logo-container">
                                        <img src="https://upload.wikimedia.org/wikipedia/ar/thumb/3/3e/Al_Rajhi_Bank_Logo.svg/512px-Al_Rajhi_Bank_Logo.svg.png" alt="شعار بنك الراجحي" class="bank-logo">
                                    </div>
                                    <div style="margin-bottom: 15px;">
                                        <h4 style="color: var(--rajhi-red); margin-bottom: 5px;">بنك الراجحي</h4>
                                        <p style="color: #6c757d; font-size: 0.9em;">افتح تطبيق الراجحي للتحويل الفوري</p>
                                    </div>
                                    <a href="https://play.google.com/store/apps/details?id=com.alrajhiretailapp" class="bank-transfer-btn rajhi" target="_blank" onclick="openBankApp('rajhi', event)">
                                        <i class="fas fa-external-link-alt"></i> فتح تطبيق الراجحي
                                    </a>
                                </div>
                                
                                <!-- البنك الأهلي -->
                                <div class="bank-option-card" id="ahli-option-card" onclick="selectBank('ahli')">
                                    <div class="bank-logo-container">
                                        <img src="https://upload.wikimedia.org/wikipedia/ar/thumb/6/6d/Saudi_National_Bank_Logo.svg/512px-Saudi_National_Bank_Logo.svg.png" alt="شعار البنك الأهلي السعودي" class="bank-logo">
                                    </div>
                                    <div style="margin-bottom: 15px;">
                                        <h4 style="color: var(--ahli-blue); margin-bottom: 5px;">البنك الأهلي السعودي</h4>
                                        <p style="color: #6c757d; font-size: 0.9em;">افتح تطبيق الأهلي للتحويل الفوري</p>
                                    </div>
                                    <a href="https://play.google.com/store/apps/details?id=com.snb.alahlimobile" class="bank-transfer-btn ahli" target="_blank" onclick="openBankApp('ahli', event)">
                                        <i class="fas fa-external-link-alt"></i> فتح تطبيق الأهلي
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- رفع الإيصال -->
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-receipt"></i> رفع إيصال الدفع الأول *
                            </label>
                            <p style="color: #6c757d; margin-top: 5px; margin-bottom: 15px; font-size: 0.95em;">بعد إتمام التحويل بنجاح، يرجى رفع صورة إيصال الدفع هنا للتحقق.</p>
                            <div class="receipt-upload" onclick="document.getElementById('receiptFile').click()" id="receiptUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>اضغط لرفع إيصال التحويل</h4>
                                <p style="color: #6c757d; margin-top: 10px;">الصيغ المدعومة: JPG, PNG, PDF</p>
                                <p id="fileName" style="color: var(--primary); font-weight: 600; margin-top: 10px;"></p>
                            </div>
                            <input type="file" id="receiptFile" accept=".jpg,.jpeg,.png,.pdf" style="display: none;" onchange="handleReceiptUpload(this)">
                        </div>
                        
                        <!-- الشروط -->
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="agreeTerms" required style="width: 20px; height: 20px;">
                                <span>أوافق على شروط وأحكام الجمعية وسياسة الخصوصية *</span>
                            </label>
                        </div>
                        
                        <div class="warning-box" style="margin: 30px 0;">
                            <h4><i class="fas fa-info-circle"></i> تعليمات مهمة للتحويل:</h4>
                            <p>
                                1. رقم حساب الجمعية أعلاه هو الرقم الرسمي الوحيد للتحويل.<br>
                                2. تأكد من مطابقة الرقم <strong>SA035600035686889898989898585</strong> في تطبيق البنك قبل التأكيد.<br>
                                3. احتفظ بإيصال التحويل وارفعه في الحقل المخصص.<br>
                                4. لن تتمكن الجمعية من الوصول إلى أموالك. التحويل يتم مباشرة إلى حساب الجمعية المركزي.
                            </p>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="prevStep()">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-check-circle"></i> تأكيد التسجيل
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </section>
        
        <!-- صفحة لوحة التحكم -->
        <section id="dashboard" class="page-section">
            <div class="section-card">
                <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</h2>
                
                <div id="loginPrompt" style="text-align: center; padding: 50px;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">تسجيل الدخول</h3>
                    <p style="color: #6c757d; margin-bottom: 30px;">أدخل رقم الجوال للدخول إلى حسابك</p>
                    
                    <div style="max-width: 400px; margin: 0 auto;">
                        <input type="tel" class="form-input" id="loginPhone" placeholder="أدخل رقم الجوال المسجل" style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="loginUser()" style="width: 100%;">
                            <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                        </button>
                    </div>
                    
                    <p style="color: #6c757d; margin-top: 20px; font-size: 0.9em;">
                        إذا كنت مسجلاً من قبل، سيتم تحميل بياناتك تلقائياً
                    </p>
                </div>
                
                <div id="dashboardContent" style="display: none;">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <h3><i class="fas fa-user"></i> بيانات العضو</h3>
                            <div class="stat-value" id="userName">-</div>
                            <div class="stat-label" id="userId">رقم العضو: -</div>
                        </div>
                        
                        <div class="stat-card">
                            <h3><i class="fas fa-coins"></i> الجمعية</h3>
                            <div class="stat-value" id="userPlan">-</div>
                            <div class="stat-label" id="userRole">الدور: -</div>
                        </div>
                        
                        <div class="stat-card">
                            <h3><i class="fas fa-money-check"></i> المدفوعات</h3>
                            <div class="stat-value" id="totalPaid">0 ر.س</div>
                            <div class="stat-label">إجمالي المدفوع</div>
                        </div>
                        
                        <div class="stat-card">
                            <h3><i class="fas fa-calendar-check"></i> الاستلام</h3>
                            <div class="stat-value" id="receiveDate">-</div>
                            <div class="stat-label">تاريخ الاستلام المتوقع</div>
                        </div>
                    </div>
                    
                    <!-- قسم جديد: رقم حساب الجمعية في لوحة التحكم -->
                    <div style="margin-top: 40px;">
                        <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-university"></i> معلومات التحويل
                        </h3>
                        <div class="account-number-display">
                            <h4 style="color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <i class="fas fa-credit-card"></i> رقم حساب الجمعية للدفعات الشهرية
                            </h4>
                            <span class="account-number">SA035600035686889898989898585</span>
                            <p style="color: #6c757d; font-size: 0.9em; margin-top: 15px;">
                                <i class="fas fa-info-circle"></i> استخدم هذا الرقم للتحويل الشهري. تأكد من مطابقته دائماً.
                            </p>
                            
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                                <a href="https://play.google.com/store/apps/details?id=com.alrajhiretailapp" class="bank-transfer-btn rajhi" target="_blank" style="width: auto; padding: 10px 20px;">
                                    <i class="fas fa-mobile-alt"></i> الراجحي
                                </a>
                                <a href="https://play.google.com/store/apps/details?id=com.snb.alahlimobile" class="bank-transfer-btn ahli" target="_blank" style="width: auto; padding: 10px 20px;">
                                    <i class="fas fa-mobile-alt"></i> الأهلي
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- رفع الإيصالات -->
                    <div style="margin-top: 40px;">
                        <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-receipt"></i> رفع إيصالات الدفع
                        </h3>
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
                            <div class="receipt-upload" onclick="document.getElementById('paymentReceipt').click()" id="paymentReceiptUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>اضغط لرفع إيصال الدفع الشهري</h4>
                                <p style="color: #6c757d; margin-top: 10px;">الصيغ المدعومة: JPG, PNG, PDF</p>
                            </div>
                            <input type="file" id="paymentReceipt" accept=".jpg,.jpeg,.png,.pdf" style="display: none;" onchange="handlePaymentReceipt(this)">
                        </div>
                    </div>
                    
                    <!-- سجل الدفعات -->
                    <div style="margin-top: 40px;">
                        <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-history"></i> سجل الدفعات
                        </h3>
                        <div id="paymentHistory" style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                            <p style="color: #6c757d; text-align: center;">لا توجد دفعات مسجلة بعد</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- صفحة الدردشة -->
        <section id="chat" class="page-section">
            <div class="section-card">
                <h2 class="section-title"><i class="fas fa-comments"></i> الدردشة والدعم</h2>
                
                <div class="chat-container">
                    <div class="chat-sidebar">
                        <div style="padding: 20px; background: var(--primary); color: white;">
                            <h3 style="margin: 0;">الدردشات النشطة</h3>
                        </div>
                        <div id="chatContacts" style="padding: 20px;">
                            <div class="chat-contact active" onclick="openChat('admin')" style="padding: 15px; border-bottom: 1px solid #dee2e6; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 40px; height: 40px; background: var(--rajhi-red); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-headset"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">الدعم الفني</div>
                                        <div style="font-size: 0.85em; color: #6c757d;">متصل الآن</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-messages">
                        <div class="messages-header">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 40px; height: 40px; background: white; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-headset"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; font-size: 1.1em;">الدعم الفني</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">يدعمك في جميع استفسارات الجمعية</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="messages-list" id="messagesList">
                            <!-- الرسائل ستظهر هنا -->
                        </div>
                        
                        <div class="message-input">
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="chatInput" class="form-input" placeholder="اكتب رسالتك هنا..." style="flex: 1;">
                                <button class="btn btn-primary" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- صفحة عن الجمعية -->
        <section id="about" class="page-section">
            <div class="section-card">
                <h2 class="section-title"><i class="fas fa-info-circle"></i> نبذة عن الجمعية</h2>
                
                <div style="margin-bottom: 40px;">
                    <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-university"></i> تعريف الجمعية
                    </h3>
                    <p style="line-height: 1.8; color: #495057; font-size: 1.1em; margin-bottom: 20px;">
                        الجمعية التعاونية هي نظام توفير جماعي يهدف إلى تنظيم المدخرات بين مجموعة من الأفراد بشكل دوري ومنظم. 
                        تعمل على مبدأ التعاون والتكافل الاجتماعي حيث يلتزم كل عضو بدفع مبلغ شهري ثابت، ويحصل كل عضو على مجموع 
                        المدخرات دفعة واحدة حسب الدور المحدد له مسبقاً.
                    </p>
                    
                    <div class="warning-box">
                        <h4><i class="fas fa-exclamation-circle"></i> تنويه هام:</h4>
                        <p>الجمعية <strong>ليست استثماراً</strong> ولا تقدم <strong>أرباحاً أو فوائد</strong>. النظام مبني على أساس 
                        <strong>التوفير الجماعي المنظم</strong> فقط. كل عضو يسترد ما دفعه بالكامل حسب دور الاستلام المحدد له.</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 40px;">
                    <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-bullseye"></i> أهداف الجمعية
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border-right: 4px solid var(--primary);">
                            <h4><i class="fas fa-hand-holding-usd"></i> تنظيم التوفير</h4>
                            <p style="color: #495057; margin-top: 10px;">مساعدة الأفراد على تنظيم مدخراتهم بشكل دوري ومنظم.</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border-right: 4px solid var(--primary);">
                            <h4><i class="fas fa-users"></i> تعزيز التعاون</h4>
                            <p style="color: #495057; margin-top: 10px;">بناء مجتمع تعاوني يساعد بعضه البعض في تحقيق الأهداف المالية.</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border-right: 4px solid var(--primary);">
                            <h4><i class="fas fa-shield-alt"></i> الأمان والشفافية</h4>
                            <p style="color: #495057; margin-top: 10px;">توفير بيئة آمنة وشفافة لجميع العمليات المالية.</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border-right: 4px solid var(--primary);">
                            <h4><i class="fas fa-balance-scale"></i> العدالة والتنظيم</h4>
                            <p style="color: #495057; margin-top: 10px;">ضمان العدالة في توزيع الأدوار والالتزام بالجدول الزمني.</p>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-phone-alt"></i> التواصل معنا
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                        <div style="text-align: center; padding: 25px; background: #f8f9fa; border-radius: 12px;">
                            <div style="font-size: 2.5em; color: var(--primary); margin-bottom: 15px;"><i class="fas fa-phone"></i></div>
                            <h4>الهاتف</h4>
                            <p style="color: #495057; margin-top: 10px;">9200 2020</p>
                        </div>
                        
                        <div style="text-align: center; padding: 25px; background: #f8f9fa; border-radius: 12px;">
                            <div style="font-size: 2.5em; color: var(--primary); margin-bottom: 15px;"><i class="fas fa-envelope"></i></div>
                            <h4>البريد الإلكتروني</h4>
                            <p style="color: #495057; margin-top: 10px;">support@aljam3ia.com</p>
                        </div>
                        
                        <div style="text-align: center; padding: 25px; background: #f8f9fa; border-radius: 12px;">
                            <div style="font-size: 2.5em; color: var(--primary); margin-bottom: 15px;"><i class="fas fa-clock"></i></div>
                            <h4>ساعات العمل</h4>
                            <p style="color: #495057; margin-top: 10px;">8 صباحاً - 4 مساءً</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- تذييل الصفحة -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>عن المنصة</h3>
                <p style="color: #adb5bd; line-height: 1.6;">منصة الجمعيات التعاونية - نظام توفير جماعي آمن وشفاف لتنظيم الدفعات بدون فوائد.</p>
            </div>
            
            <div class="footer-section">
                <h3>روابط سريعة</h3>
                <ul class="footer-links">
                    <li><a href="#" onclick="showPage('home')"><i class="fas fa-home"></i> الرئيسية</a></li>
                    <li><a href="#" onclick="showPage('register')"><i class="fas fa-user-plus"></i> التسجيل</a></li>
                    <li><a href="#" onclick="showPage('about')"><i class="fas fa-info-circle"></i> عن الجمعية</a></li>
                    <li><a href="#" onclick="showPage('chat')"><i class="fas fa-comments"></i> الدردشة</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>التواصل</h3>
                <ul class="footer-links">
                    <li><i class="fas fa-phone"></i> 9200 2020</li>
                    <li><i class="fas fa-envelope"></i> support@aljam3ia.com</li>
                    <li><i class="fas fa-map-marker-alt"></i> المملكة العربية السعودية</li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>حسابات الجمعية الرسمية</h3>
                <div style="margin-top: 15px;">
                    <p style="color: #adb5bd; font-size: 0.9em; margin-bottom: 10px;">رقم الحساب الوحيد للتحويل:</p>
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 0.9em; word-break: break-all; direction: ltr; text-align: center;">
                        SA035600035686889898989898585
                    </div>
                </div>
            </div>
        </div>
        
        <div class="copyright">
            <p>© 2024 منصة الجمعيات التعاونية. جميع الحقوق محفوظة. | نظام تنظيم الدفعات بدون فوائد</p>
        </div>
    </footer>
    
    <!-- نافذة تسجيل الدخول -->
    <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%;">
            <h3 style="color: var(--primary); margin-bottom: 30px; text-align: center;">تسجيل الدخول</h3>
            
            <div style="margin-bottom: 20px;">
                <label>رقم الجوال</label>
                <input type="tel" class="form-input" id="modalPhone" placeholder="أدخل رقم الجوال المسجل">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="closeLoginModal()" style="flex: 1;">
                    إلغاء
                </button>
                <button class="btn btn-primary" onclick="modalLogin()" style="flex: 1;">
                    دخول
                </button>
            </div>
        </div>
    </div>
    
    <!-- نافذة الإشعارات -->
    <div id="notificationModal" style="display: none; position: fixed; bottom: 20px; left: 20px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 10000; max-width: 350px;">
        <div style="display: flex; align-items: start; gap: 15px;">
            <div style="font-size: 24px; color: var(--primary);"><i class="fas fa-bell"></i></div>
            <div>
                <div style="font-weight: 600; color: var(--primary); margin-bottom: 5px;">إشعار</div>
                <div id="notificationMessage" style="color: #495057;"></div>
            </div>
            <button onclick="closeNotification()" style="background: none; border: none; color: #6c757d; cursor: pointer;">×</button>
        </div>
    </div>

    <script>
    // ==============================================
    // النظام الأساسي - الإصدار المحدث مع البنوك
    // ==============================================
    
    // المتغيرات العامة
    let currentUser = null;
    let currentStep = 1;
    let selectedPlan = null;
    let selectedBank = null;
    let receiptFile = null;
    
    // البيانات المخزنة
    const users = JSON.parse(localStorage.getItem('cooperative_users')) || [];
    const visitors = JSON.parse(localStorage.getItem('cooperative_visitors')) || [];
    const messages = JSON.parse(localStorage.getItem('cooperative_messages')) || [];
    
    // ==============================================
    // 1. تهيئة النظام
    // ==============================================
    
    function initSystem() {
        console.log('جاري تهيئة النظام...');
        trackVisitor();
        loadMessages();
        checkLoginStatus();
        setupEventListeners();
        
        // تهيئة خطوات التسجيل
        updateStepIndicators();
    }
    
    function updateStepIndicators() {
        document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
            indicator.classList.toggle('active', index + 1 === currentStep);
        });
    }
    
    // ==============================================
    // 2. إدارة الصفحات
    // ==============================================
    
    function showPage(pageId) {
        console.log('جاري التبديل إلى صفحة:', pageId);
        
        // إخفاء جميع الصفحات
        document.querySelectorAll('.page-section').forEach(page => {
            page.classList.remove('active');
        });
        
        // تحديث القائمة
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // إظهار الصفحة المطلوبة
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        } else {
            console.error('الصفحة غير موجودة:', pageId);
        }
        
        // تحديث النشطة في القائمة
        const pageNames = {
            'home': 'الرئيسية',
            'register': 'التسجيل',
            'dashboard': 'لوحة التحكم',
            'chat': 'الدردشة',
            'about': 'عن الجمعية'
        };
        
        document.querySelectorAll('.nav-item').forEach(item => {
            const text = item.textContent.trim();
            const pageName = pageNames[pageId];
            if (pageName && text.includes(pageName)) {
                item.classList.add('active');
            }
        });
        
        // إذا كانت لوحة التحكم، تحديث البيانات
        if (pageId === 'dashboard') {
            updateDashboard();
        }
        
        // إذا كانت الدردشة، تحديث الرسائل
        if (pageId === 'chat') {
            updateChatMessages();
        }
        
        // إذا كانت صفحة التسجيل، إعادة تعيين الخطوات
        if (pageId === 'register') {
            resetRegistrationSteps();
        }
    }
    
    function resetRegistrationSteps() {
        console.log('جاري إعادة تعيين خطوات التسجيل');
        currentStep = 1;
        updateStepIndicators();
        
        // إظهار الخطوة الأولى فقط
        document.querySelectorAll('.form-step').forEach(step => {
            step.classList.remove('active');
        });
        
        const step1Form = document.getElementById('step1-form');
        if (step1Form) {
            step1Form.classList.add('active');
        }
    }
    
    // ==============================================
    // 3. إدارة خطوات التسجيل
    // ==============================================
    
    function nextStep(step) {
        console.log('الانتقال إلى الخطوة:', step);
        
        // التحقق من الخطوة الحالية
        if (step === 2) {
            if (!validateStep1()) {
                showNotification('الرجاء ملء جميع الحقول المطلوبة في البيانات الشخصية', 'error');
                return;
            }
            updateReviewData();
        }
        
        if (step === 3) {
            if (!selectedPlan) {
                showNotification('الرجاء اختيار نوع الجمعية أولاً', 'error');
                return;
            }
            
            updateReviewData();
        }
        
        // إخفاء الخطوة الحالية
        document.querySelectorAll('.form-step').forEach(formStep => {
            formStep.classList.remove('active');
        });
        
        // إظهار الخطوة الجديدة
        const targetForm = document.getElementById(`step${step}-form`);
        if (targetForm) {
            targetForm.classList.add('active');
        }
        
        // تحديث المؤشرات
        currentStep = step;
        updateStepIndicators();
    }
    
    function prevStep() {
        console.log('العودة للخطوة السابقة');
        if (currentStep > 1) {
            // إخفاء الخطوة الحالية
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // إظهار الخطوة السابقة
            const prevForm = document.getElementById(`step${currentStep - 1}-form`);
            if (prevForm) {
                prevForm.classList.add('active');
            }
            
            // تحديث المؤشرات
            currentStep--;
            updateStepIndicators();
        }
    }
    
    function validateStep1() {
        console.log('جاري التحقق من الخطوة 1');
        const required = ['fullName', 'nationalId', 'phone', 'email', 'city', 'birthDate'];
        let isValid = true;
        
        for (const field of required) {
            const input = document.getElementById(field);
            if (!input) continue;
            
            if (!input.value.trim()) {
                input.style.borderColor = 'var(--danger)';
                isValid = false;
                console.log('حقل مطلوب فارغ:', field);
            } else {
                input.style.borderColor = '#dee2e6';
            }
        }
        
        return isValid;
    }
    
    // ==============================================
    // 4. اختيار الجمعية
    // ==============================================
    
    function selectPlan(planType) {
        console.log('تم اختيار الجمعية:', planType);
        selectedPlan = planType;
        
        // إزالة التحديد من جميع البطاقات
        document.querySelectorAll('.plan-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // إضافة التحديد للبطاقة المختارة
        const selectedCard = document.querySelector(`.plan-card[data-plan="${planType}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
        
        const planNames = {
            '500': '500 ريال',
            '1000': '1,000 ريال',
            '5000': '5,000 ريال'
        };
        
        // إظهار نص التأكيد
        const selectedPlanText = document.getElementById('selectedPlanText');
        const selectedPlanName = document.getElementById('selectedPlanName');
        
        if (selectedPlanText && selectedPlanName) {
            selectedPlanText.style.display = 'block';
            selectedPlanName.textContent = planNames[planType] || planType;
        }
        
        showNotification(`تم اختيار جمعية ${planNames[planType] || planType}`, 'success');
    }
    
    // ==============================================
    // 5. اختيار البنك وفتح التطبيق - دالة جديدة
    // ==============================================
    
    function selectBank(bankType) {
        console.log('تم اختيار البنك:', bankType);
        selectedBank = bankType;
        
        // إزالة التحديد من جميع بطاقات البنوك
        document.querySelectorAll('.bank-option-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // إضافة التحديد للبطاقة المختارة
        const selectedBankCard = document.getElementById(`${bankType}-option-card`);
        if (selectedBankCard) {
            selectedBankCard.classList.add('selected');
        }
        
        const bankNames = {
            'rajhi': 'الراجحي',
            'ahli': 'الأهلي السعودي'
        };
        
        showNotification(`تم اختيار بنك ${bankNames[bankType]}`, 'success');
    }
    
    // دالة فتح تطبيق البنك
    function openBankApp(bankType, event) {
        // منع السلوك الافتراضي مؤقتاً لإظهار التنبيه
        if (event) {
            event.preventDefault();
        }
        
        const bankNames = {
            'rajhi': 'الراجحي',
            'ahli': 'الأهلي'
        };
        
        const urls = {
            'rajhi': 'https://play.google.com/store/apps/details?id=com.alrajhiretailapp',
            'ahli': 'https://play.google.com/store/apps/details?id=com.snb.alahlimobile'
        };
        
        // تأكيد للمستخدم
        if (confirm(`سيتم فتح تطبيق بنك ${bankNames[bankType]} في نافذة جديدة. الرابط آمن ومباشر إلى متجر التطبيقات الرسمي. هل تريد المتابعة؟`)) {
            // فتح الرابط في نافذة جديدة
            window.open(urls[bankType], '_blank');
            
            // إظهار رسالة تذكير بالحساب
            setTimeout(() => {
                showNotification(`تذكر استخدام رقم الحساب: SA035600035686889898989898585 في تطبيق البنك`, 'info');
            }, 500);
        }
    }
    
    // ==============================================
    // 6. تحديث بيانات المراجعة
    // ==============================================
    
    function updateReviewData() {
        console.log('جاري تحديث بيانات المراجعة');
        
        const planNames = {
            '500': 'جمعية 500 ريال',
            '1000': 'جمعية 1000 ريال',
            '5000': 'جمعية 5000 ريال'
        };
        
        const bankNames = {
            'rajhi': 'بنك الراجحي',
            'ahli': 'البنك الأهلي السعودي'
        };
        
        const data = {
            '👤 الاسم': getValue('fullName'),
            '🆔 رقم الهوية': getValue('nationalId'),
            '📱 رقم الجوال': getValue('phone'),
            '📧 البريد الإلكتروني': getValue('email'),
            '🏙️ المدينة': getSelectText('city'),
            '💰 نوع الجمعية': selectedPlan ? planNames[selectedPlan] : 'لم يتم الاختيار',
            '🏦 البنك المفضل': selectedBank ? bankNames[selectedBank] : 'لم يتم الاختيار',
            '💳 رقم حساب الجمعية': 'SA035600035686889898989898585'
        };
        
        const reviewDiv = document.getElementById('reviewData');
        if (reviewDiv) {
            reviewDiv.innerHTML = Object.entries(data).map(([key, value]) => `
                <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #dee2e6;">
                    <span style="color: #495057; font-weight: 500;">${key}</span>
                    <span style="color: var(--primary); font-weight: 600; text-align: left; ${key.includes('حساب') ? 'direction: ltr; font-family: monospace;' : ''}">${value}</span>
                </div>
            `).join('');
        }
    }
    
    function getValue(elementId) {
        const element = document.getElementById(elementId);
        return element ? element.value : '';
    }
    
    function getSelectText(elementId) {
        const select = document.getElementById(elementId);
        if (!select) return '';
        return select.options[select.selectedIndex] ? select.options[select.selectedIndex].text : '';
    }
    
    // ==============================================
    // 7. رفع الإيصالات
    // ==============================================
    
    function handleReceiptUpload(input) {
        console.log('جاري رفع الإيصال');
        if (input.files && input.files[0]) {
            const file = input.files[0];
            receiptFile = file;
            
            const fileName = document.getElementById('fileName');
            const receiptUpload = document.getElementById('receiptUpload');
            
            if (fileName) fileName.textContent = file.name;
            if (receiptUpload) {
                receiptUpload.style.borderColor = 'var(--success)';
                receiptUpload.style.background = 'rgba(46, 139, 87, 0.05)';
            }
            
            showNotification('تم رفع الإيصال بنجاح', 'success');
        }
    }
    
    function handlePaymentReceipt(input) {
        console.log('جاري رفع إيصال الدفع');
        
        if (!currentUser) {
            showNotification('الرجاء تسجيل الدخول أولاً', 'error');
            return;
        }
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // تحديث دفعات المستخدم
            const month = (currentUser.payments ? currentUser.payments.length : 0) + 1;
            const amount = currentUser.plan === '500' ? 500 : 
                          currentUser.plan === '1000' ? 1000 : 
                          currentUser.plan === '5000' ? 5000 : 0;
            
            const payment = {
                month: month,
                amount: amount,
                date: new Date().toLocaleDateString('ar-SA'),
                receiptName: file.name,
                accountUsed: 'SA035600035686889898989898585'
            };
            
            if (!currentUser.payments) currentUser.payments = [];
            currentUser.payments.push(payment);
            
            if (!currentUser.totalPaid) currentUser.totalPaid = 0;
            currentUser.totalPaid += amount;
            
            // تحديث التخزين المحلي
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('cooperative_users', JSON.stringify(users));
            }
            
            showNotification(`تم رفع إيصال الدفع للشهر ${month} بنجاح`, 'success');
            updateDashboard();
        }
    }
    
    // ==============================================
    // 8. التسجيل
    // ==============================================
    
    async function handleRegistration(e) {
        e.preventDefault();
        console.log('جاري معالجة التسجيل');
        
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التسجيل...';
            submitBtn.disabled = true;
        }
        
        try {
            // جمع البيانات
            const userData = {
                fullName: getValue('fullName'),
                nationalId: getValue('nationalId'),
                phone: getValue('phone'),
                email: getValue('email'),
                city: getValue('city'),
                birthDate: getValue('birthDate'),
                iban: 'SA035600035686889898989898585', // استخدام رقم الحساب الجديد
                plan: selectedPlan,
                bank: selectedBank
            };
            
            console.log('بيانات المستخدم:', userData);
            
            // التحقق من البيانات
            if (!validateRegistrationData(userData)) {
                throw new Error('الرجاء ملء جميع الحقول المطلوبة');
            }
            
            // التحقق من عدم التسجيل المسبق
            if (users.find(u => u.nationalId === userData.nationalId)) {
                throw new Error('رقم الهوية مسجل مسبقاً');
            }
            
            if (users.find(u => u.phone === userData.phone)) {
                throw new Error('رقم الجوال مسجل مسبقاً');
            }
            
            if (!receiptFile) {
                throw new Error('الرجاء رفع إيصال الدفع');
            }
            
            // التحقق من الموافقة على الشروط
            const agreeTerms = document.getElementById('agreeTerms');
            if (!agreeTerms || !agreeTerms.checked) {
                throw new Error('الرجاء الموافقة على الشروط والأحكام');
            }
            
            // إنشاء رقم العضو
            const memberId = 'MEM' + Date.now().toString().slice(-6);
            const nextRole = users.length + 1;
            
            // حساب تاريخ الاستلام
            const receiveDate = calculateReceiveDate(nextRole);
            
            // إنشاء العضو
            const newUser = {
                id: memberId,
                ...userData,
                role: nextRole,
                receiveDate: receiveDate,
                registrationDate: new Date().toISOString(),
                status: 'active',
                totalPaid: 0,
                payments: [],
                associationAccount: 'SA035600035686889898989898585', // حفظ رقم حساب الجمعية مع بيانات العضو
                loginHistory: [{
                    timestamp: new Date().toISOString(),
                    action: 'registration'
                }]
            };
            
            console.log('تم إنشاء مستخدم جديد:', newUser);
            
            // حفظ العضو
            users.push(newUser);
            localStorage.setItem('cooperative_users', JSON.stringify(users));
            
            // تسجيل الدخول التلقائي
            currentUser = newUser;
            localStorage.setItem('last_login', memberId);
            
            showNotification(`مبروك! تم التسجيل بنجاح. رقم عضويتك: ${memberId}`, 'success');
            
            // عرض صفحة النجاح
            showRegistrationSuccess(memberId, nextRole, receiveDate);
            
        } catch (error) {
            console.error('خطأ في التسجيل:', error);
            showNotification(error.message, 'error');
            
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> تأكيد التسجيل';
                submitBtn.disabled = false;
            }
        }
    }
    
    function validateRegistrationData(data) {
        console.log('جاري التحقق من بيانات التسجيل');
        const requiredFields = ['fullName', 'nationalId', 'phone', 'email', 'city', 'birthDate', 'plan'];
        
        for (const field of requiredFields) {
            if (!data[field] || data[field].toString().trim() === '') {
                console.log('حقل مطلوب فارغ:', field);
                return false;
            }
        }
        
        if (!/^\d{10}$/.test(data.nationalId.replace(/\D/g, ''))) {
            console.log('رقم الهوية غير صالح');
            return false;
        }
        
        if (!/^05\d{8}$/.test(data.phone.replace(/\D/g, ''))) {
            console.log('رقم الجوال غير صالح');
            return false;
        }
        
        return true;
    }
    
    function calculateReceiveDate(role) {
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() + role);
        startDate.setDate(1);
        return startDate.toLocaleDateString('ar-SA');
    }
    
    function showRegistrationSuccess(memberId, role, receiveDate) {
        console.log('عرض صفحة النجاح');
        
        const planNames = {
            '500': 'جمعية 500 ريال',
            '1000': 'جمعية 1000 ريال',
            '5000': 'جمعية 5000 ريال'
        };
        
        const bankNames = {
            'rajhi': 'الراجحي',
            'ahli': 'الأهلي السعودي'
        };
        
        const step3Form = document.getElementById('step3-form');
        if (!step3Form) return;
        
        step3Form.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 60px; color: var(--success); margin-bottom: 20px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 style="color: var(--primary); margin-bottom: 20px;">تم التسجيل بنجاح!</h3>
                <p style="color: #495057; margin-bottom: 30px;">مبروك! أصبحت الآن عضواً في الجمعية التعاونية</p>
                
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; max-width: 500px; margin: 0 auto 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: right;">
                        <div><strong><i class="fas fa-id-card"></i> رقم العضو:</strong></div>
                        <div>${memberId}</div>
                        
                        <div><strong><i class="fas fa-coins"></i> نوع الجمعية:</strong></div>
                        <div>${planNames[selectedPlan] || 'غير محدد'}</div>
                        
                        <div><strong><i class="fas fa-list-ol"></i> الدور:</strong></div>
                        <div>${role}</div>
                        
                        <div><strong><i class="fas fa-calendar-check"></i> تاريخ الاستلام:</strong></div>
                        <div>${receiveDate}</div>
                        
                        <div><strong><i class="fas fa-university"></i> رقم حساب الجمعية:</strong></div>
                        <div style="direction: ltr; font-family: monospace; font-size: 0.9em;">SA035600035686889898989898585</div>
                    </div>
                </div>
                
                <div style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                    <h4 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-envelope"></i> تم إرسال البيانات
                    </h4>
                    <p style="color: #495057;">تم إرسال تفاصيل حسابك إلى البريد الإلكتروني: ${getValue('email')}</p>
                    <p style="color: #495057; margin-top: 10px; font-size: 0.95em;">
                        <i class="fas fa-info-circle"></i> يرجى الاحتفاظ برقم حساب الجمعية للدفعات الشهرية القادمة.
                    </p>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 30px;">
                    <button class="btn btn-primary" onclick="showPage('dashboard')" style="padding: 15px 30px;">
                        <i class="fas fa-tachometer-alt"></i> لوحة التحكم
                    </button>
                    <button class="btn btn-secondary" onclick="showPage('home')" style="padding: 15px 30px;">
                        <i class="fas fa-home"></i> الرئيسية
                    </button>
                </div>
            </div>
        `;
    }
    
    // ==============================================
    // 9. تسجيل الدخول
    // ==============================================
    
    function loginUser() {
        console.log('جاري تسجيل الدخول');
        const phoneInput = document.getElementById('loginPhone');
        if (!phoneInput) return;
        
        const phone = phoneInput.value;
        if (!phone) {
            showNotification('الرجاء إدخال رقم الجوال', 'error');
            return;
        }
        
        const cleanPhone = phone.replace(/\D/g, '');
        const user = users.find(u => u.phone && u.phone.replace(/\D/g, '') === cleanPhone);
        
        if (user) {
            currentUser = user;
            
            // تحديث سجل الدخول
            if (!user.loginHistory) user.loginHistory = [];
            user.loginHistory.push({
                timestamp: new Date().toISOString(),
                action: 'login'
            });
            
            localStorage.setItem('cooperative_users', JSON.stringify(users));
            localStorage.setItem('last_login', user.id);
            
            showNotification(`مرحباً بعودتك ${user.fullName}!`, 'success');
            updateDashboard();
            
        } else {
            showNotification('رقم الجوال غير مسجل', 'error');
        }
    }
    
    function checkLoginStatus() {
        console.log('جاري التحقق من حالة تسجيل الدخول');
        const lastLogin = localStorage.getItem('last_login');
        if (lastLogin) {
            const user = users.find(u => u.id === lastLogin);
            if (user) {
                currentUser = user;
                updateDashboard();
            }
        }
    }
    
    // ==============================================
    // 10. لوحة التحكم
    // ==============================================
    
    function updateDashboard() {
        console.log('جاري تحديث لوحة التحكم');
        
        const loginPrompt = document.getElementById('loginPrompt');
        const dashboardContent = document.getElementById('dashboardContent');
        
        if (!loginPrompt || !dashboardContent) return;
        
        if (currentUser) {
            loginPrompt.style.display = 'none';
            dashboardContent.style.display = 'block';
            
            // تحديث البيانات
            updateElementText('userName', currentUser.fullName);
            updateElementText('userId', `رقم العضو: ${currentUser.id}`);
            
            const planNames = {
                '500': '500 ريال',
                '1000': '1,000 ريال',
                '5000': '5,000 ريال'
            };
            
            updateElementText('userPlan', planNames[currentUser.plan] || 'غير محدد');
            updateElementText('userRole', `الدور: ${currentUser.role || 'غير محدد'}`);
            updateElementText('totalPaid', `${(currentUser.totalPaid || 0).toLocaleString()} ر.س`);
            updateElementText('receiveDate', currentUser.receiveDate || '-');
            
            updatePaymentHistory();
            
        } else {
            loginPrompt.style.display = 'block';
            dashboardContent.style.display = 'none';
        }
    }
    
    function updateElementText(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = text;
        }
    }
    
    function updatePaymentHistory() {
        console.log('جاري تحديث سجل الدفعات');
        const container = document.getElementById('paymentHistory');
        if (!container) return;
        
        if (currentUser.payments && currentUser.payments.length > 0) {
            container.innerHTML = currentUser.payments.map(payment => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #dee2e6;">
                    <div>
                        <div style="font-weight: 600; color: var(--primary);">دفعة شهر ${payment.month}</div>
                        <div style="color: #6c757d; font-size: 0.9em; margin-top: 5px;">
                            <i class="fas fa-calendar"></i> ${payment.date || 'غير محدد'}
                            ${payment.accountUsed ? '<br><i class="fas fa-credit-card"></i> ' + payment.accountUsed : ''}
                        </div>
                    </div>
                    <div style="color: var(--success); font-weight: 600; font-size: 1.1em;">
                        ${(payment.amount || 0).toLocaleString()} ر.س
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-receipt" style="font-size: 3em; color: #adb5bd; margin-bottom: 20px;"></i>
                    <p style="color: #6c757d;">لا توجد دفعات مسجلة بعد</p>
                </div>
            `;
        }
    }
    
    // ==============================================
    // 11. الدردشة
    // ==============================================
    
    function loadMessages() {
        console.log('جاري تحميل الرسائل');
        
        // إذا كانت الرسائل فارغة، نضيف رسالة ترحيبية
        if (messages.length === 0) {
            messages.push({
                id: 1,
                sender: 'system',
                text: 'مرحباً بك في الدردشة! كيف يمكنني مساعدتك اليوم؟',
                timestamp: new Date().toISOString(),
                read: false
            });
            localStorage.setItem('cooperative_messages', JSON.stringify(messages));
        }
        
        updateChatMessages();
    }
    
    function sendMessage() {
        console.log('جاري إرسال الرسالة');
        const input = document.getElementById('chatInput');
        if (!input) return;
        
        const message = input.value.trim();
        if (!message) return;
        
        // إضافة رسالة المستخدم
        messages.push({
            id: Date.now(),
            sender: 'user',
            text: message,
            timestamp: new Date().toISOString(),
            read: false
        });
        
        // مسح حقل الإدخال
        input.value = '';
        
        localStorage.setItem('cooperative_messages', JSON.stringify(messages));
        updateChatMessages();
        
        // رد تلقائي بعد ثانية
        setTimeout(() => {
            const responses = [
                "شكراً لرسالتك. سأرد عليك قريباً.",
                "تم استلام رسالتك. كيف يمكنني مساعدتك في شؤون الجمعية؟",
                "هل لديك استفسار حول دفعتك الشهرية؟ تذكر رقم الحساب: SA035600035686889898989898585",
                "يمكنني مساعدتك في معرفة دورك القادم في الجمعية.",
                "شكراً لتواصلك معنا. فريق الدعم سيرد عليك في أقرب وقت."
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            messages.push({
                id: Date.now() + 1,
                sender: 'system',
                text: randomResponse,
                timestamp: new Date().toISOString(),
                read: false
            });
            
            localStorage.setItem('cooperative_messages', JSON.stringify(messages));
            updateChatMessages();
            
        }, 1000);
    }
    
    function updateChatMessages() {
        console.log('جاري تحديث الرسائل');
        const container = document.getElementById('messagesList');
        if (!container) return;
        
        // ترتيب الرسائل حسب الوقت
        const sortedMessages = [...messages].sort((a, b) => 
            new Date(a.timestamp) - new Date(b.timestamp)
        );
        
        container.innerHTML = sortedMessages.map(msg => {
            const isUser = msg.sender === 'user';
            return `
                <div class="message" style="margin-bottom: 15px; text-align: ${isUser ? 'left' : 'right'}">
                    <div style="
                        background: ${isUser ? 'var(--primary)' : '#f1f3f4'};
                        color: ${isUser ? 'white' : '#495057'};
                        padding: 12px 16px;
                        border-radius: ${isUser ? '15px 15px 0 15px' : '15px 15px 15px 0'};
                        max-width: 70%;
                        display: inline-block;
                        text-align: ${isUser ? 'left' : 'right'};
                    ">
                        <div style="font-size: 0.95em;">${msg.text}</div>
                        <div style="
                            font-size: 0.75em;
                            margin-top: 5px;
                            opacity: 0.7;
                            text-align: ${isUser ? 'left' : 'right'};
                        ">
                            ${formatTime(msg.timestamp)}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        // التمرير للأسفل
        container.scrollTop = container.scrollHeight;
    }
    
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('ar-SA', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
    }
    
    // ==============================================
    // 12. نافذة تسجيل الدخول
    // ==============================================
    
    function openLogin() {
        console.log('فتح نافذة تسجيل الدخول');
        document.getElementById('loginModal').style.display = 'flex';
    }
    
    function closeLoginModal() {
        console.log('إغلاق نافذة تسجيل الدخول');
        document.getElementById('loginModal').style.display = 'none';
    }
    
    function modalLogin() {
        console.log('تسجيل الدخول من النافذة');
        const phoneInput = document.getElementById('modalPhone');
        if (!phoneInput) return;
        
        const phone = phoneInput.value;
        if (!phone) {
            showNotification('الرجاء إدخال رقم الجوال', 'error');
            return;
        }
        
        const cleanPhone = phone.replace(/\D/g, '');
        const user = users.find(u => u.phone && u.phone.replace(/\D/g, '') === cleanPhone);
        
        if (user) {
            currentUser = user;
            localStorage.setItem('last_login', user.id);
            showNotification(`مرحباً ${user.fullName}!`, 'success');
            updateDashboard();
            closeLoginModal();
            showPage('dashboard');
        } else {
            showNotification('رقم الجوال غير مسجل', 'error');
        }
    }
    
    // ==============================================
    // 13. الإشعارات
    // ==============================================
    
    function showNotification(message, type = 'info') {
        console.log('إشعار:', message, 'نوع:', type);
        
        const modal = document.getElementById('notificationModal');
        const messageEl = document.getElementById('notificationMessage');
        
        if (!modal || !messageEl) return;
        
        messageEl.textContent = message;
        
        const icon = modal.querySelector('i');
        if (icon) {
            if (type === 'success') {
                icon.style.color = '#2E8B57';
            } else if (type === 'error') {
                icon.style.color = '#CE1126';
            } else {
                icon.style.color = '#1A5F7A';
            }
        }
        
        modal.style.display = 'block';
        
        // إخفاء الإشعار بعد 5 ثوانٍ
        setTimeout(() => {
            modal.style.display = 'none';
        }, 5000);
    }
    
    function closeNotification() {
        console.log('إغلاق الإشعار');
        document.getElementById('notificationModal').style.display = 'none';
    }
    
    // ==============================================
    // 14. تتبع الزوار
    // ==============================================
    
    function trackVisitor() {
        console.log('تتبع الزائر');
        
        // استخدام sessionStorage لمنع التتبع المتكرر في نفس الجلسة
        const sessionKey = 'cooperative_visitor_tracked';
        if (sessionStorage.getItem(sessionKey)) {
            console.log('تم تتبع الزائر في هذه الجلسة بالفعل');
            return;
        }
        
        const visitorId = 'VISIT_' + Date.now();
        const visitorData = {
            id: visitorId,
            timestamp: new Date().toISOString(),
            lastVisit: new Date().toLocaleString('ar-SA'),
            userAgent: navigator.userAgent
        };
        
        visitors.push(visitorData);
        localStorage.setItem('cooperative_visitors', JSON.stringify(visitors));
        sessionStorage.setItem(sessionKey, 'true');
        
        console.log('تم تتبع زائر جديد:', visitorId);
    }
    
    // ==============================================
    // 15. إعداد مستمعي الأحداث
    // ==============================================
    
    function setupEventListeners() {
        console.log('جاري إعداد مستمعي الأحداث');
        
        // نموذج التسجيل
        const form = document.getElementById('registrationForm');
        if (form) {
            form.addEventListener('submit', handleRegistration);
        }
        
        // الدردشة
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // إضافة مستمعي الأحداث لأزرار البنوك
        document.querySelectorAll('.bank-option-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // إذا كان النقر على زر فتح التطبيق، لا ننفذ selectBank
                if (e.target.closest('.bank-transfer-btn')) {
                    return;
                }
                const bank = this.id.replace('-option-card', '');
                selectBank(bank);
            });
        });
        
        // مستمع للأزرار داخل بطاقات الجمعيات
        document.querySelectorAll('.plan-card button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                const card = this.closest('.plan-card');
                if (card && card.dataset.plan) {
                    selectPlan(card.dataset.plan);
                }
            });
        });
    }
    
    // ==============================================
    // 16. تهيئة النظام عند تحميل الصفحة
    // ==============================================
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('الصفحة تم تحميلها بنجاح');
        initSystem();
        
        // إضافة رسالة ترحيبية افتراضية في الدردشة
        if (messages.length === 0) {
            setTimeout(() => {
                messages.push({
                    id: 1,
                    sender: 'system',
                    text: 'مرحباً بك في منصة الجمعيات التعاونية! أنا المساعد الذكي. كيف يمكنني مساعدتك اليوم؟',
                    timestamp: new Date().toISOString(),
                    read: false
                });
                localStorage.setItem('cooperative_messages', JSON.stringify(messages));
                updateChatMessages();
            }, 1000);
        }
    });
    
    // ==============================================
    // 17. وظائف مساعدة إضافية
    // ==============================================
    
    // تنظيف البيانات (لأغراض التطوير)
    function clearAllData() {
        if (confirm('هل أنت متأكد من مسح جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.')) {
            localStorage.removeItem('cooperative_users');
            localStorage.removeItem('cooperative_visitors');
            localStorage.removeItem('cooperative_messages');
            localStorage.removeItem('last_login');
            sessionStorage.removeItem('cooperative_visitor_tracked');
            
            location.reload();
        }
    }
    
    // تصدير البيانات (لأغراض النسخ الاحتياطي)
    function exportData() {
        const data = {
            users: users,
            visitors: visitors,
            messages: messages
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = 'cooperative_data_backup.json';
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    }
    
    // دالة نسخ رقم الحساب إلى الحافظة
    function copyAccountNumber() {
        const accountNumber = 'SA035600035686889898989898585';
        navigator.clipboard.writeText(accountNumber).then(() => {
            showNotification('تم نسخ رقم الحساب إلى الحافظة', 'success');
        }).catch(err => {
            console.error('فشل في النسخ: ', err);
            showNotification('فشل نسخ رقم الحساب. يرجى نسخه يدوياً.', 'error');
        });
    }
    </script>
</body>
</html>
